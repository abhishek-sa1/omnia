# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Get the software organized by group
  group_package_map:
    input_path: "{{ hostvars['localhost']['input_project_dir'] }}"
  register: grouped_packages
  delegate_to: localhost
  connection: local

- name: Get all discovered nodes from DB
  community.postgresql.postgresql_query:
    login_db: omniadb
    login_user: postgres
    query: |
      SELECT node,hostname,admin_ip,role,group_name,service_tag
      FROM cluster.nodeinfo
      WHERE node!='oim' and status = 'booted';
    login_password: "{{ hostvars['localhost']['postgresdb_password'] }}"
  register: db_result
  delegate_to: omnia_provision

- name: Group nodes by group_name
  ansible.builtin.set_fact:
    grouped_nodes: "{{ grouped_nodes | default({})
     | combine({item.group_name: (grouped_nodes[item.group_name] | default([]))
      + [item.admin_ip]}) }}" # admin_ip is the IP address of the node
  loop: "{{ db_result.query_result }}"

- name: Pull images for group
  ansible.builtin.include_tasks: image_pulling.yml
  loop: "{{ grouped_nodes | default({}) | dict2items }}"
  loop_control:
    loop_var: grp

- name: Install the rpm for group
  ansible.builtin.include_tasks: install_packages.yml
  loop: "{{ grouped_nodes | default({}) | dict2items }}"
  loop_control:
    loop_var: grp
