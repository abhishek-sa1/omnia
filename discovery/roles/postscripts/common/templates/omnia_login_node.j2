#!/bin/bash
#####################################################################################################
#  Omnia Login:
#      Install required Slurm packages for Login Node role
#
#####################################################################################################

LOGFILE="/var/log/xcat/xcat.log"

echo "--------------------------" >> "$LOGFILE"
echo "Starting login_node role package installation" | tee -a "$LOGFILE"

# Collect all packages into a single list
ALL_PACKAGES=(
    {% for pkg in common_packages %} "{{ pkg.package }}" {% endfor %}
    {% for pkg in role_specific_packages %} "{{ pkg.package }}" {% endfor %}
)

echo "DEBUG: Installing packages - ${ALL_PACKAGES[*]}" | tee -a "$LOGFILE"

# Install all packages in one command
if ! dnf install -y "${ALL_PACKAGES[@]}" >> "$LOGFILE" 2>&1; then
    echo "WARNING: Some packages failed to install. Check $LOGFILE for details." | tee -a "$LOGFILE"
else
    echo "SUCCESS: All packages installed successfully!" | tee -a "$LOGFILE"
fi

echo "--------------------------" >> "$LOGFILE"
echo "Login role setup complete." | tee -a "$LOGFILE"
