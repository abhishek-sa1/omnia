- name: hostname
  description: "hostname config"
  file:
    encoding: plain
    content: |
      ## template: jinja
      #cloud-config
      merge_how:
        - name: list
          settings: [append]
        - name: dict
          settings: [no_replace, recurse_list]
 
      write_files:
        - path: /usr/local/bin/set-hostname-by-mac.sh
          permissions: '0755'
          content: |
            #!/bin/bash
            # Autogenerated hostname & IP setter based on NIC MAC
            for IFACE in /sys/class/net/*; do
                MAC=$(cat $IFACE/address | tr '[:upper:]' '[:lower:]')
                case $MAC in
                {% for item in nodes %}
                {{ item.value.ADMIN_MAC }}) HOST={{ item.value.HOSTNAME }} IP={{ item.value.ADMIN_IP }} ;;
                {% endfor %}
                esac
            done
 
            if [ -n "$HOST" ]; then
                hostnamectl set-hostname "$HOST"
                if ! grep -q "$HOST" /etc/hosts; then
                    echo "$IP $HOST" >> /etc/hosts
                fi
            fi
 
      runcmd:
        - /usr/local/bin/set-hostname-by-mac.sh
