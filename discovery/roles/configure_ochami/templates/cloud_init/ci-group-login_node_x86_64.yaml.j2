- name: {{ functional_group_name }}
  description: "{{ functional_group_name }} config"
  file:
    encoding: plain
    content: |
      ## template: jinja
      #cloud-config
      merge_how:
      - name: list
        settings: [append]
      - name: dict
        settings: [no_replace, recurse_list]
      users:
        - name: root
          ssh_authorized_keys: "{{ read_ssh_key.stdout }}"
      disable_root: false
      write_files:
        - path: /usr/local/bin/set-hostname-by-mac.sh
          permissions: '0755'
          content: |
            #!/bin/bash
            # Autogenerated hostname & IP setter based on NIC MAC
            DOMAIN_NAME={{ hostvars['localhost']['domain_name'] }}
            for IFACE in /sys/class/net/*; do
                MAC=$(cat $IFACE/address | tr '[:upper:]' '[:lower:]')
                case $MAC in
                {% for node in nodes %}
                {{ node.interfaces[0].mac_addr | lower }}) HOST={{ node.name }} IP={{ node.interfaces[0].ip_addrs[0].ip_addr }} ;;
                {% endfor %}
                esac
            done

            if [ -n "$HOST" ]; then
                if ! grep -q "$HOST" /etc/hosts; then
                    echo "$IP $HOST.$DOMAIN_NAME" >> /etc/hosts
                fi
                hostnamectl set-hostname "$HOST.$DOMAIN_NAME"
                sysctl kernel.hostname=$HOST.$DOMAIN_NAME
            fi

            echo 'root:{{ hostvars['localhost']['provision_password'] }}' | chpasswd
            timedatectl set-timezone {{ hostvars['localhost']['timezone'] }}
            localectl set-locale LANG={{ hostvars['localhost']['language'] }}
            sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
            sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
            sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config.d/50-cloud-init.conf
            systemctl restart sshd
        - path: /etc/sssd/sssd.conf
          owner: root:root
          permissions: '0600'
          content: |
            {{ lookup('template', 'templates/openldap/sssd.conf.j2') | indent(6) }}
        - path: /usr/local/bin/update_ldap_conf.sh
          owner: root:root
          permissions: '0755'
          content: |
            {{ lookup('template', 'templates/openldap/update_ldap_conf.sh.j2') | indent(12) }}

      runcmd:
        - /usr/local/bin/set-hostname-by-mac.sh
        - /usr/local/bin/update_ldap_conf.sh
        - authselect select sssd with-mkhomedir --force
        - sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config.d/50-cloud-init.conf
        - setenforce 0
        - sudo systemctl enable --now oddjobd.service
        - sudo systemctl enable --now sssd
        - sudo systemctl enable --now sssd
        - setsebool -P authlogin_nsswitch_use_ldap on
        - setsebool -P authlogin_yubikey on
        - sudo systemctl stop firewalld
        - sudo systemctl disable firewalld
        - sudo systemctl restart sssd