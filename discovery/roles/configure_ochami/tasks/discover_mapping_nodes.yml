# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Include openchami vars
  ansible.builtin.include_vars: "{{ openchami_config_vars_path }}"

- name: Load the openchami nodes.yaml
  ansible.builtin.template:
    src: "{{ openchami_nodes_template }}"
    dest: "{{ openchami_nodes_vars_path }}"
    mode: "{{ file_permissions_644 }}"
  vars:
    nodes: "{{ read_mapping_file.dict | dict2items }}"

- name: Discover nodes using mapping
  ansible.builtin.shell: |
    set -o pipefail
    ansible-playbook {{ openchami_clone_path }}/dell/podman-quadlets/smd.yaml \
    -i {{ openchami_clone_path }}/dell/podman-quadlets/inventory -v \
    --extra-vars "@{{ openchami_config_vars_path }}" -v | \
    /usr/bin/tee {{ openchami_smd_log_path }}
  async: 3600  # Set async timeout (e.g., 1 hour)
  poll: 0  # Non-blocking (continue the playbook without waiting for completion)
  register: openchami_smd  # Register the result to capture job ID
  changed_when: true

- name: Wait for the discover nodes to finish. Logs can be checked at {{ openchami_smd_log_path }}
  ansible.builtin.async_status:
    jid: "{{ openchami_smd.ansible_job_id }}"  # Job ID from the previous task
  register: job_result
  until: job_result.finished
  retries: "{{ job_retry }}"  # Retry the task {{ job_retry }} times
  delay: "{{ job_delay }}"   # Wait {{ job_delay }} seconds between retries
